<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Astral Forge | Token Generator</title>
    
    <!-- PWA / Mobile App Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0F172A">

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Polyfills & Babel -->
    <script src="https://cdn.jsdelivr.net/npm/core-js-bundle@3.37.1/minified.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* --- The Astral Plane Palette (Matching Homebrew App) --- */
        :root {
            --astral-bg: #0F172A;
            --astral-card: #1E293B;
            --astral-input: #020617;
            --text-primary: #F8FAFC;
            --accent-cyan: #38BDF8;
            --accent-purple: #A855F7;
            --accent-amber: #F59E0B;
            --border-color: #334155;
        }

        body {
             background-color: #020617; 
             font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
             color: var(--text-primary);
             -webkit-font-smoothing: antialiased;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--astral-bg); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .forge-canvas {
            background-image: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }

        .animate-spin-slow { animation: spin 8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .token-glow {
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.2);
        }

        /* --- DROPDOWN MENU STYLES --- */
        .suite-item { transition: all 0.2s ease; border-left: 3px solid transparent; }
        .tracker-hover:hover { border-left-color: #A855F7; background: linear-gradient(90deg, rgba(168, 85, 247, 0.1), transparent); color: #d8b4fe; } .tracker-hover:hover svg { stroke: #A855F7; }
        .map-hover:hover { border-left-color: #22D3EE; background: linear-gradient(90deg, rgba(34, 211, 238, 0.1), transparent); color: #67e8f9; } .map-hover:hover svg { stroke: #22D3EE; }
        .sheet-hover:hover { border-left-color: #EF4444; background: linear-gradient(90deg, rgba(239, 68, 68, 0.1), transparent); color: #fca5a5; } .sheet-hover:hover svg { stroke: #EF4444; }
        .workshop-hover:hover { border-left-color: #22C55E; background: linear-gradient(90deg, rgba(34, 197, 94, 0.1), transparent); color: #86efac; } .workshop-hover:hover svg { stroke: #22C55E; }
        .forge-hover:hover { border-left-color: #F97316; background: linear-gradient(90deg, rgba(249, 115, 22, 0.1), transparent); color: #fdba74; } .forge-hover:hover svg { stroke: #F97316; }
        .loot-hover:hover { border-left-color: #F59E0B; background: linear-gradient(90deg, rgba(245, 158, 11, 0.1), transparent); color: #fcd34d; } .loot-hover:hover svg { stroke: #F59E0B; }
        .campaign-hover:hover { border-left-color: #94A3B8; background: linear-gradient(90deg, rgba(148, 163, 184, 0.1), transparent); color: #e2e8f0; } .campaign-hover:hover svg { stroke: #94A3B8; }
        .compendium-hover:hover { border-left-color: #6366F1; background: linear-gradient(90deg, rgba(99, 102, 241, 0.1), transparent); color: #a5b4fc; } .compendium-hover:hover svg { stroke: #6366F1; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONS ---
        const Icon = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Hammer = (props) => <Icon {...props}><path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"/><path d="M17.64 15 22 10.64"/><path d="m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25V7.86c0-.55-.45-1-1-1H14.14c-.83 0-1.64.34-2.25.92L3.8 15.9"/></Icon>;
        const Upload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></Icon>;
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></Icon>;
        const Sparkles = (props) => <Icon {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></Icon>;
        const Settings = (props) => <Icon {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>;
        const Key = (props) => <Icon {...props}><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></Icon>;
        const Box = (props) => <Icon {...props}><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></Icon>;
        const Rotate3D = (props) => <Icon {...props}><path d="M12.5 21a8.5 8.5 0 1 1 7.4-4.5"/><path d="M17 10v6h-6"/></Icon>;
        const ImageIcon = (props) => <Icon {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></Icon>;
        const Palette = (props) => <Icon {...props}><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></Icon>;
        const ChevronDown = (props) => <Icon {...props}><path d="m6 9 6 6 6-6"/></Icon>;
        const Home = (props) => <Icon {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></Icon>;
        
        // Suite Icons
        const Crosshair = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></Icon>;
        const Coins = (props) => <Icon {...props}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7 .71-2.82 2.82"/></Icon>;
        const User = (props) => <Icon {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>;
        const Flag = (props) => <Icon {...props}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></Icon>;
        const BookOpen = (props) => <Icon {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></Icon>;
        const FlaskConical = (props) => <Icon {...props}><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2" /><path d="M8.5 2h7" /><path d="M7 16h10" /></Icon>;
        const MapIcon = (props) => <Icon {...props}><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6" /><line x1="8" y1="2" x2="8" y2="18" /><line x1="16" y1="6" x2="16" y2="22" /></Icon>;

        // --- SUITE DROPDOWN COMPONENT ---
        const SuiteDropdown = () => {
            const [isOpen, setIsOpen] = useState(false);
            const dropdownRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, []);

            return (
                <div className="relative" ref={dropdownRef}>
                    <button 
                        onClick={() => setIsOpen(!isOpen)}
                        className={`flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-white/5 transition-colors text-slate-300 hover:text-white border border-transparent hover:border-white/10 ${isOpen ? 'bg-white/10 text-white' : ''}`}
                    >
                        <span className="text-sm font-medium">Suite Apps</span>
                        <ChevronDown size={14} className={`transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`}/>
                    </button>
                    
                    <div className={`absolute top-full right-0 mt-2 w-64 bg-slate-900/95 backdrop-blur-xl rounded-xl shadow-2xl border border-slate-700 overflow-hidden py-2 flex flex-col gap-1 z-[100] transition-all duration-200 origin-top-right ${isOpen ? 'opacity-100 scale-100 translate-y-0 pointer-events-auto' : 'opacity-0 scale-95 -translate-y-2 pointer-events-none'}`}>
                        <div className="px-4 py-2 text-[10px] font-bold text-slate-500 uppercase tracking-wider">Navigation</div>

                        {/* Tracker (Purple) */}
                        <a href="./tome.html" className="suite-item tracker-hover flex items-center gap-3 px-4 py-3 text-slate-300 hover:bg-slate-800/50">
                            <Crosshair size={18} className="text-slate-400" />
                            <div className="flex flex-col">
                                <span className="text-sm font-bold">Tracker</span>
                                <span className="text-[10px] opacity-60">Initiative & Combat</span>
                            </div>
                        </a>

                        {/* Atlas (Cyan) */}
                        <a href="./map.html" className="suite-item map-hover flex items-center gap-3 px-4 py-3 text-slate-300 hover:bg-slate-800/50">
                            <MapIcon size={18} className="text-slate-400" />
                            <div className="flex flex-col">
                                <span className="text-sm font-bold">Atlas</span>
                                <span className="text-[10px] opacity-60">Tactical Maps</span>
                            </div>
                        </a>

                        {/* Records (Red) */}
                        <a href="./sheet.html" className="suite-item sheet-hover flex items-center gap-3 px-4 py-3 text-slate-300 hover:bg-slate-800/50">
                            <User size={18} className="text-slate-400" />
                            <div className="flex flex-col">
                                <span className="text-sm font-bold">Records</span>
                                <span className="text-[10px] opacity-60">Character Sheets</span>
                            </div>
                        </a>

                        {/* Workshop (Green) */}
                        <a href="./homebrew.html" className="suite-item workshop-hover flex items-center gap-3 px-4 py-3 text-slate-300 hover:bg-slate-800/50">
                            <FlaskConical size={18} className="text-slate-400" />
                            <div className="flex flex-col">
                                <span className="text-sm font-bold">Workshop</span>
                                <span className="text-[10px] opacity-60">Monster Builder</span>
                            </div>
                        </a>

                        {/* Loot (Gold) */}
                        <a href="./loot.html" className="suite-item loot-hover flex items-center gap-3 px-4 py-3 text-slate-300 hover:bg-slate-800/50">
                            <Coins size={18} className="text-slate-400" />
                            <div className="flex flex-col">
                                <span className="text-sm font-bold">Loot</span>
                                <span className="text-[10px] opacity-60">Treasury</span>
                            </div>
                        </a>

                        {/* Campaign (Grey) */}
                        <a href="./campaign.html" className="suite-item campaign-hover flex items-center gap-3 px-4 py-3 text-slate-300 hover:bg-slate-800/50">
                            <Flag size={18} className="text-slate-400" />
                            <div className="flex flex-col">
                                <span className="text-sm font-bold">Campaign</span>
                                <span className="text-[10px] opacity-60">Adventure Module</span>
                            </div>
                        </a>

                        {/* Compendium (Indigo) */}
                        <a href="./compendium.html" className="suite-item compendium-hover flex items-center gap-3 px-4 py-3 text-slate-300 hover:bg-slate-800/50 border-t border-slate-700">
                            <BookOpen size={18} className="text-slate-400" />
                            <div className="flex flex-col">
                                <span className="text-sm font-bold">Compendium</span>
                                <span className="text-[10px] opacity-60">Rules & Spells</span>
                            </div>
                        </a>
                    </div>
                </div>
            );
        };

        // --- 3D VIEWER COMPONENT (Three.js) ---
        const TokenViewer = ({ imageUrl, isSpinning, atmosphere }) => {
            const containerRef = useRef(null);
            const sceneRef = useRef(null);
            const tokenMeshRef = useRef(null);
            const frameIdRef = useRef(null);
            const resizeObserverRef = useRef(null); // Ref for robust resizing

            useEffect(() => {
                if (!containerRef.current) return;

                // 1. Setup Scene
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                
                containerRef.current.innerHTML = '';
                containerRef.current.appendChild(renderer.domElement);

                // 2. Lighting (Dynamic based on Atmosphere)
                const lightGroup = new THREE.Group();
                scene.add(lightGroup);
                
                // Base lighting refs to update later
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
                const dirLight = new THREE.DirectionalLight(0xffffff, 1);
                dirLight.position.set(5, 10, 7);
                const backLight = new THREE.DirectionalLight(0xa855f7, 0.5);
                backLight.position.set(-5, 5, -10);
                
                lightGroup.add(ambientLight);
                lightGroup.add(dirLight);
                lightGroup.add(backLight);

                // 3. Base Mesh
                const baseGeometry = new THREE.CylinderGeometry(1.2, 1.3, 0.15, 32);
                const baseMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x1e293b, 
                    roughness: 0.3,
                    metalness: 0.8
                });
                const base = new THREE.Mesh(baseGeometry, baseMaterial);
                base.position.y = -1;
                scene.add(base);
                
                // Gold Rim
                const rimGeometry = new THREE.TorusGeometry(1.25, 0.05, 8, 32);
                const rimMaterial = new THREE.MeshStandardMaterial({ color: 0xf59e0b, metalness: 1, roughness: 0.2 });
                const rim = new THREE.Mesh(rimGeometry, rimMaterial);
                rim.rotation.x = Math.PI / 2;
                rim.position.y = -1;
                scene.add(rim);

                // 4. Token Plane
                const planeGeometry = new THREE.PlaneGeometry(2.5, 2.5);
                const planeMaterial = new THREE.MeshBasicMaterial({ 
                    color: 0xffffff,
                    side: THREE.DoubleSide,
                    transparent: true,
                    opacity: 0.5 
                });
                const plane = new THREE.Mesh(planeGeometry, planeMaterial);
                plane.position.y = 0.4;
                scene.add(plane);

                tokenMeshRef.current = plane;
                sceneRef.current = { scene, camera, renderer, plane, base, rim, ambientLight, dirLight, backLight };

                // Camera Position
                camera.position.z = 4;
                camera.position.y = 1;
                camera.lookAt(0, 0, 0);

                // 5. Resize Handling
                const handleResize = () => {
                    if (!containerRef.current || !renderer || !camera) return;
                    const width = containerRef.current.clientWidth;
                    const height = containerRef.current.clientHeight;
                    if (width === 0 || height === 0) return;
                    camera.aspect = width / height;
                    camera.updateProjectionMatrix();
                    renderer.setSize(width, height);
                };

                resizeObserverRef.current = new ResizeObserver((entries) => {
                    for (let entry of entries) handleResize();
                });
                resizeObserverRef.current.observe(containerRef.current);

                // Animation
                const animate = () => {
                    frameIdRef.current = requestAnimationFrame(animate);
                    
                    if (isSpinning && sceneRef.current) {
                        const time = Date.now() * 0.001;
                        camera.position.x = Math.sin(time * 0.5) * 4;
                        camera.position.z = Math.cos(time * 0.5) * 4;
                        camera.lookAt(0, 0, 0);
                    } else if (sceneRef.current) {
                        const time = Date.now() * 0.001;
                        sceneRef.current.plane.position.y = 0.4 + Math.sin(time) * 0.05;
                    }
                    
                    if (sceneRef.current) renderer.render(scene, camera);
                };
                animate();

                return () => {
                    cancelAnimationFrame(frameIdRef.current);
                    if (resizeObserverRef.current) resizeObserverRef.current.disconnect();
                    if (containerRef.current && renderer.domElement) {
                        containerRef.current.removeChild(renderer.domElement);
                    }
                    renderer.dispose();
                };
            }, []); 

            // Handle Atmosphere Changes
            useEffect(() => {
                if (!sceneRef.current) return;
                const { ambientLight, dirLight, backLight } = sceneRef.current;
                
                const palettes = {
                    standard: { ambient: 0xffffff, dir: 0xffffff, back: 0xa855f7, ambientInt: 0.8 },
                    eldritch: { ambient: 0x1a472a, dir: 0x4ade80, back: 0x9333ea, ambientInt: 0.5 }, // Green/Purple
                    infernal: { ambient: 0x450a0a, dir: 0xf87171, back: 0xf59e0b, ambientInt: 0.6 }, // Red/Gold
                    void:     { ambient: 0x020617, dir: 0x38bdf8, back: 0xffffff, ambientInt: 0.4 }  // Deep Blue/Cyan
                };

                const p = palettes[atmosphere] || palettes.standard;

                ambientLight.color.setHex(p.ambient);
                ambientLight.intensity = p.ambientInt;
                dirLight.color.setHex(p.dir);
                backLight.color.setHex(p.back);

            }, [atmosphere]);

            // Handle Image Texture
            useEffect(() => {
                if (imageUrl && sceneRef.current) {
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);

                        // Auto-remove white background
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;
                        const threshold = 230;

                        for (let i = 0; i < data.length; i += 4) {
                            const r = data[i];
                            const g = data[i + 1];
                            const b = data[i + 2];
                            if (r > threshold && g > threshold && b > threshold) {
                                data[i + 3] = 0;
                            }
                        }
                        ctx.putImageData(imageData, 0, 0);

                        const texture = new THREE.CanvasTexture(canvas);
                        texture.encoding = THREE.sRGBEncoding;

                        sceneRef.current.plane.material.map = texture;
                        sceneRef.current.plane.material.color.setHex(0xffffff);
                        sceneRef.current.plane.material.opacity = 1;
                        sceneRef.current.plane.material.transparent = true;
                        sceneRef.current.plane.material.side = THREE.DoubleSide;
                        sceneRef.current.plane.material.needsUpdate = true;
                    };
                    img.src = imageUrl;
                }
            }, [imageUrl]);

            return <div ref={containerRef} className="w-full h-full relative z-0" />;
        };

        // --- MAIN APP COMPONENT ---
        function App() {
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('astral-forge-key') || "");
            const [monsters, setMonsters] = useState([]);
            const [selectedMonster, setSelectedMonster] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);
            const [generatedImage, setGeneratedImage] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [isSpinning, setIsSpinning] = useState(true);
            const [atmosphere, setAtmosphere] = useState('standard');
            const [customPrompt, setCustomPrompt] = useState("");
            
            const fileInputRef = useRef(null);
            const imageInputRef = useRef(null);

            // Persist API Key
            useEffect(() => {
                if (apiKey) localStorage.setItem('astral-forge-key', apiKey);
            }, [apiKey]);

            // Handle File Import
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (Array.isArray(data)) {
                            setMonsters(data);
                            if (data.length > 0) handleSelectMonster(data[0]);
                        } else {
                            alert("Invalid file format. Expected a list of monsters.");
                        }
                    } catch (err) {
                        alert("Error parsing JSON: " + err.message);
                    }
                };
                reader.readAsText(file);
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    setGeneratedImage(event.target.result);
                };
                reader.readAsDataURL(file);
            };

            const handleSelectMonster = (m) => {
                setSelectedMonster(m);
                if (m.visualDescription && m.visualDescription.length > 10) {
                     setCustomPrompt(m.visualDescription);
                } else {
                     setCustomPrompt(`${m.name}, ${m.type || 'monster'}. ${m.statBlockSummary || 'A fantasy creature.'}`);
                }
                setGeneratedImage(null);
            };

            // Image Generation Logic
            const generateToken = async () => {
                if (!apiKey) {
                    setShowSettings(true);
                    return;
                }
                setIsGenerating(true);

                const prompt = `Full body fantasy concept art of ${customPrompt}. The character is standing in a heroic pose, isolated on a solid white background. High detailed, vibrant colors, rpg tabletop miniature style, digital painting, sharp edges.`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            instances: [{ prompt: prompt }],
                            parameters: { sampleCount: 1 }
                        })
                    });

                    const data = await response.json();
                    
                    if (!response.ok) {
                         throw new Error(data.error?.message || response.statusText);
                    }

                    if (data.predictions && data.predictions[0]) {
                        const base64Image = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                        setGeneratedImage(base64Image);
                    } else {
                        throw new Error("No image data returned.");
                    }
                } catch (error) {
                    console.error("Generation failed:", error);
                    if (error.message.includes("billed users") || error.message.includes("403")) {
                         alert("⚠️ Billing Required for AI Art\n\nGoogle's Imagen model requires a billed Cloud project. \n\nFALLBACK: Please use the 'Upload Art' button to use your own image instead!");
                    } else {
                         alert(`Failed to generate image: ${error.message}`);
                    }
                } finally {
                    setIsGenerating(false);
                }
            };

            const downloadImage = () => {
                if (!generatedImage) return;
                const link = document.createElement('a');
                link.href = generatedImage;
                link.download = `${selectedMonster?.name || 'token'}_art.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    
                    {/* LEFT SIDEBAR: Controls & List */}
                    <div className="w-full md:w-80 bg-slate-900 border-r border-slate-800 flex flex-col h-screen max-h-screen overflow-hidden">
                        
                        {/* Header */}
                        <div className="p-4 border-b border-slate-800 bg-slate-950 flex flex-col gap-2">
                            <div className="flex justify-between items-center">
                                <h1 className="text-xl font-bold text-amber-500 flex items-center gap-2">
                                    <Hammer size={24} /> The Astral Forge
                                </h1>
                                {/* HOME BUTTON ADDED */}
                                <a href="./index.html" className="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded transition-colors" title="Back to Hub"><Home size={18} /></a>
                            </div>
                            <div className="flex justify-between items-center">
                                <p className="text-xs text-slate-500">3D Token Generator for VTTs</p>
                                {/* SUITE DROPDOWN ADDED */}
                                <div className="scale-75 origin-right">
                                    <SuiteDropdown />
                                </div>
                            </div>
                        </div>

                        {/* Monster List */}
                        <div className="flex-1 overflow-y-auto p-2 space-y-1">
                            {monsters.length === 0 ? (
                                <div className="p-6 text-center text-slate-500 flex flex-col items-center">
                                    <p className="mb-4 text-sm">No monsters loaded.</p>
                                    <button 
                                        onClick={() => fileInputRef.current.click()}
                                        className="bg-indigo-600 hover:bg-indigo-500 text-white text-sm px-4 py-2 rounded-lg flex items-center gap-2 transition-colors"
                                    >
                                        <Upload size={16} /> Import JSON
                                    </button>
                                    <p className="mt-4 text-xs text-slate-600">Import your <code>homebrew_bank.json</code> file to begin.</p>
                                </div>
                            ) : (
                                monsters.map((m, idx) => (
                                    <button
                                        key={m.id || idx}
                                        onClick={() => handleSelectMonster(m)}
                                        className={`w-full text-left p-3 rounded-lg border transition-all ${
                                            selectedMonster === m 
                                                ? 'bg-amber-900/20 border-amber-600 text-white' 
                                                : 'bg-slate-800/50 border-slate-700 text-slate-400 hover:bg-slate-800 hover:text-slate-200'
                                        }`}
                                    >
                                        <div className="font-bold text-sm truncate">{m.name}</div>
                                        <div className="text-xs opacity-70 truncate flex items-center gap-1">
                                            {m.type} • CR {m.cr || '?'}
                                            {m.visualDescription && <span title="Has Visual Prompt" className="text-amber-500 ml-1"><Sparkles size={10}/></span>}
                                        </div>
                                    </button>
                                ))
                            )}
                        </div>

                        {/* Bottom Actions */}
                        <div className="p-4 border-t border-slate-800 bg-slate-950 flex gap-2">
                            <input type="file" ref={fileInputRef} onChange={handleFileUpload} className="hidden" accept=".json" />
                            <button onClick={() => fileInputRef.current.click()} className="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 py-2 rounded text-xs font-bold border border-slate-700">
                                Import Bank
                            </button>
                            <button onClick={() => setShowSettings(true)} className="p-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded border border-slate-700">
                                <Settings size={18} />
                            </button>
                        </div>
                    </div>

                    {/* RIGHT MAIN AREA: 3D Preview & Generation */}
                    <div className="flex-1 bg-slate-950 p-4 md:p-6 flex flex-col h-screen overflow-hidden relative">
                        
                        {selectedMonster ? (
                            <div className="flex flex-col h-full gap-4">
                                {/* Top Bar: Controls */}
                                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-slate-900 p-4 rounded-xl border border-slate-800 z-10">
                                    <div className="flex-1 w-full">
                                        <label className="text-xs font-bold text-slate-500 uppercase block mb-1">Visual Prompt</label>
                                        <div className="flex gap-2">
                                            <input 
                                                type="text" 
                                                value={customPrompt} 
                                                onChange={(e) => setCustomPrompt(e.target.value)}
                                                className="flex-1 bg-slate-950 border border-slate-700 rounded px-3 py-2 text-sm text-white focus:border-amber-500 focus:outline-none"
                                            />
                                            {/* UPLOAD ART BUTTON */}
                                            <input type="file" ref={imageInputRef} onChange={handleImageUpload} className="hidden" accept="image/*" />
                                            <button 
                                                onClick={() => imageInputRef.current.click()}
                                                className="px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 border border-slate-600 text-slate-300 hover:text-white transition-colors"
                                                title="Upload your own art"
                                            >
                                                <ImageIcon size={18} />
                                            </button>

                                            <button 
                                                onClick={generateToken}
                                                disabled={isGenerating}
                                                className={`px-4 py-2 rounded font-bold text-white flex items-center gap-2 whitespace-nowrap transition-all ${
                                                    isGenerating ? 'bg-slate-700 cursor-not-allowed' : 'bg-gradient-to-r from-amber-600 to-red-600 hover:from-amber-500 hover:to-red-500 shadow-lg shadow-amber-900/20'
                                                }`}
                                            >
                                                {isGenerating ? <Sparkles className="animate-spin" size={18} /> : <Sparkles size={18} />}
                                                {isGenerating ? 'Forging...' : 'Forge'}
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* 3D Canvas Area */}
                                <div className="flex-1 relative forge-canvas border border-slate-800 flex items-center justify-center">
                                    {/* 3D Viewer Overlay Controls */}
                                    <div className="absolute top-4 right-4 z-20 flex flex-col gap-2">
                                        
                                        {/* Atmosphere Toggle */}
                                        <div className="bg-slate-900/90 backdrop-blur border border-slate-700 rounded-lg p-1 flex flex-col gap-1">
                                            {['standard', 'eldritch', 'infernal', 'void'].map(mode => (
                                                <button
                                                    key={mode}
                                                    onClick={() => setAtmosphere(mode)}
                                                    className={`p-1.5 rounded transition-all flex items-center gap-2 ${atmosphere === mode ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`}
                                                    title={`Set Lighting: ${mode.charAt(0).toUpperCase() + mode.slice(1)}`}
                                                >
                                                    <Palette size={14} />
                                                    <span className="text-[10px] uppercase font-bold">{mode}</span>
                                                </button>
                                            ))}
                                        </div>

                                        <button 
                                            onClick={() => setIsSpinning(!isSpinning)}
                                            className={`p-2 rounded-lg border backdrop-blur-sm transition-colors mt-2 ${isSpinning ? 'bg-amber-500/20 border-amber-500 text-amber-500' : 'bg-slate-900/50 border-slate-600 text-slate-400'}`}
                                            title="Toggle Rotation"
                                        >
                                            <Rotate3D size={20} />
                                        </button>
                                        {generatedImage && (
                                            <button 
                                                onClick={downloadImage}
                                                className="p-2 bg-indigo-600/90 hover:bg-indigo-500 text-white rounded-lg border border-indigo-400 shadow-lg backdrop-blur-sm"
                                                title="Download 2D Token Art"
                                            >
                                                <Download size={20} />
                                            </button>
                                        )}
                                    </div>

                                    {/* 3D Viewer */}
                                    <TokenViewer imageUrl={generatedImage} isSpinning={isSpinning} atmosphere={atmosphere} />
                                    
                                    {/* Overlay Text if no image */}
                                    {!generatedImage && !isGenerating && (
                                        <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none opacity-50">
                                            <Box size={48} className="text-slate-600 mb-2" />
                                            <p className="text-slate-500 font-serif italic">The anvil is cold. Click "Forge Token" to begin.</p>
                                        </div>
                                    )}
                                </div>

                                {/* Token Details Footer */}
                                <div className="h-16 bg-slate-900 rounded-xl border border-slate-800 flex items-center px-6 justify-between">
                                    <div>
                                        <h2 className="font-bold text-slate-200">{selectedMonster.name}</h2>
                                        <p className="text-xs text-slate-500">HP: {selectedMonster.hp} | AC: {selectedMonster.ac}</p>
                                    </div>
                                    {generatedImage && <span className="text-xs text-green-400 flex items-center gap-1 font-bold"><Sparkles size={12}/> Token Ready</span>}
                                </div>
                            </div>
                        ) : (
                            <div className="flex-1 flex flex-col items-center justify-center text-slate-600 opacity-50">
                                <Box size={64} strokeWidth={1} className="mb-6 text-slate-700"/>
                                <h2 className="text-2xl font-bold text-slate-500 mb-2">The Forge Awaits</h2>
                                <p>Select a monster from your bank to begin smithing.</p>
                            </div>
                        )}
                    </div>

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
                            <div className="bg-slate-900 w-full max-w-md rounded-xl border border-slate-700 p-6 shadow-2xl">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                        <Settings className="text-slate-400" /> Settings
                                    </h2>
                                    <button onClick={() => setShowSettings(false)} className="text-slate-400 hover:text-white"><Icon><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon></button>
                                </div>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold text-slate-300 mb-2 flex items-center gap-2">
                                            <Key size={16} className="text-amber-500" /> Gemini/Imagen API Key
                                        </label>
                                        <input 
                                            type="password" 
                                            placeholder="Paste API key..." 
                                            className="w-full bg-slate-950 border border-slate-700 rounded px-3 py-2 text-white focus:border-amber-500 focus:outline-none"
                                            value={apiKey}
                                            onChange={(e) => setApiKey(e.target.value)}
                                        />
                                        <p className="text-xs text-slate-500 mt-2">
                                            Required for image generation. Keys are stored locally in your browser.
                                        </p>
                                    </div>
                                    <button 
                                        onClick={() => setShowSettings(false)}
                                        className="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 rounded transition-colors"
                                    >
                                        Save Credentials
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>